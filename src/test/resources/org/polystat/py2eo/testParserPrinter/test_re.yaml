python: |
  from test.support import (gc_collect, bigmemtest, _2G,
                            cpython_only, captured_stdout)
  import locale
  import re
  import sre_compile
  import string
  import unittest
  import warnings
  from re import Scanner
  from weakref import proxy
  
  # Misc tests from Tim Peters' re.doc
  
  # WARNING: Don't change details in these tests if you don't know
  # what you're doing. Some of these tests were carefully modeled to
  # cover most of the code.
  
  class S(str):
      def __getitem__(self, index):
          return S(super().__getitem__(index))
  
  class B(bytes):
      def __getitem__(self, index):
          return B(super().__getitem__(index))
  
  class ReTests(unittest.TestCase):
  
      def assertTypedEqual(self, actual, expect, msg=None):
          self.assertEqual(actual, expect, msg)
          def recurse(actual, expect):
              if isinstance(expect, (tuple, list)):
                  for x, y in zip(actual, expect):
                      recurse(x, y)
              else:
                  self.assertIs(type(actual), type(expect), msg)
          recurse(actual, expect)
  
      def checkPatternError(self, pattern, errmsg, pos=None):
          with self.assertRaises(re.error) as cm:
              re.compile(pattern)
          with self.subTest(pattern=pattern):
              err = cm.exception
              self.assertEqual(err.msg, errmsg)
              if pos is not None:
                  self.assertEqual(err.pos, pos)
  
      def checkTemplateError(self, pattern, repl, string, errmsg, pos=None):
          with self.assertRaises(re.error) as cm:
              re.sub(pattern, repl, string)
          with self.subTest(pattern=pattern, repl=repl):
              err = cm.exception
              self.assertEqual(err.msg, errmsg)
              if pos is not None:
                  self.assertEqual(err.pos, pos)
  
      def test_keep_buffer(self):
          # See bug 14212
          b = bytearray(b'x')
          it = re.finditer(b'a', b)
          with self.assertRaises(BufferError):
              b.extend(b'x'*400)
          list(it)
          del it
          gc_collect()
          b.extend(b'x'*400)
  
      def test_weakref(self):
          s = 'QabbbcR'
          x = re.compile('ab+c')
          y = proxy(x)
          self.assertEqual(x.findall('QabbbcR'), y.findall('QabbbcR'))
  
      def test_search_star_plus(self):
          self.assertEqual(re.search('x*', 'axx').span(0), (0, 0))
          self.assertEqual(re.search('x*', 'axx').span(), (0, 0))
          self.assertEqual(re.search('x+', 'axx').span(0), (1, 3))
          self.assertEqual(re.search('x+', 'axx').span(), (1, 3))
          self.assertIsNone(re.search('x', 'aaa'))
          self.assertEqual(re.match('a*', 'xxx').span(0), (0, 0))
          self.assertEqual(re.match('a*', 'xxx').span(), (0, 0))
          self.assertEqual(re.match('x*', 'xxxa').span(0), (0, 3))
          self.assertEqual(re.match('x*', 'xxxa').span(), (0, 3))
          self.assertIsNone(re.match('a+', 'xxx'))
  
      def bump_num(self, matchobj):
          int_value = int(matchobj.group(0))
          return str(int_value + 1)
  
      def test_basic_re_sub(self):
          self.assertTypedEqual(re.sub('y', 'a', 'xyz'), 'xaz')
          self.assertTypedEqual(re.sub('y', S('a'), S('xyz')), 'xaz')
          self.assertTypedEqual(re.sub(b'y', b'a', b'xyz'), b'xaz')
          self.assertTypedEqual(re.sub(b'y', B(b'a'), B(b'xyz')), b'xaz')
          self.assertTypedEqual(re.sub(b'y', bytearray(b'a'), bytearray(b'xyz')), b'xaz')
          self.assertTypedEqual(re.sub(b'y', memoryview(b'a'), memoryview(b'xyz')), b'xaz')
          for y in ("\xe0", "\u0430", "\U0001d49c"):
              self.assertEqual(re.sub(y, 'a', 'x%sz' % y), 'xaz')
  
          self.assertEqual(re.sub("(?i)b+", "x", "bbbb BBBB"), 'x x')
          self.assertEqual(re.sub(r'\d+', self.bump_num, '08.2 -2 23x99y'),
                           '9.3 -3 24x100y')
          self.assertEqual(re.sub(r'\d+', self.bump_num, '08.2 -2 23x99y', 3),
                           '9.3 -3 23x99y')
          self.assertEqual(re.sub(r'\d+', self.bump_num, '08.2 -2 23x99y', count=3),
                           '9.3 -3 23x99y')
  
          self.assertEqual(re.sub('.', lambda m: r"\n", 'x'), '\\n')
          self.assertEqual(re.sub('.', r"\n", 'x'), '\n')
  
          s = r"\1\1"
          self.assertEqual(re.sub('(.)', s, 'x'), 'xx')
          self.assertEqual(re.sub('(.)', s.replace('\\', r'\\'), 'x'), s)
          self.assertEqual(re.sub('(.)', lambda m: s, 'x'), s)
  
          self.assertEqual(re.sub('(?P<a>x)', r'\g<a>\g<a>', 'xx'), 'xxxx')
          self.assertEqual(re.sub('(?P<a>x)', r'\g<a>\g<1>', 'xx'), 'xxxx')
          self.assertEqual(re.sub('(?P<unk>x)', r'\g<unk>\g<unk>', 'xx'), 'xxxx')
          self.assertEqual(re.sub('(?P<unk>x)', r'\g<1>\g<1>', 'xx'), 'xxxx')
  
          self.assertEqual(re.sub('a', r'\t\n\v\r\f\a\b', 'a'), '\t\n\v\r\f\a\b')
          self.assertEqual(re.sub('a', '\t\n\v\r\f\a\b', 'a'), '\t\n\v\r\f\a\b')
          self.assertEqual(re.sub('a', '\t\n\v\r\f\a\b', 'a'),
                           (chr(9)+chr(10)+chr(11)+chr(13)+chr(12)+chr(7)+chr(8)))
          for c in 'cdehijklmopqsuwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ':
              with self.subTest(c):
                  with self.assertRaises(re.error):
                      self.assertEqual(re.sub('a', '\\' + c, 'a'), '\\' + c)
  
          self.assertEqual(re.sub(r'^\s*', 'X', 'test'), 'Xtest')
  
      def test_bug_449964(self):
          # fails for group followed by other escape
          self.assertEqual(re.sub(r'(?P<unk>x)', r'\g<1>\g<1>\b', 'xx'),
                           'xx\bxx\b')
  
      def test_bug_449000(self):
          # Test for sub() on escaped characters
          self.assertEqual(re.sub(r'\r\n', r'\n', 'abc\r\ndef\r\n'),
                           'abc\ndef\n')
          self.assertEqual(re.sub('\r\n', r'\n', 'abc\r\ndef\r\n'),
                           'abc\ndef\n')
          self.assertEqual(re.sub(r'\r\n', '\n', 'abc\r\ndef\r\n'),
                           'abc\ndef\n')
          self.assertEqual(re.sub('\r\n', '\n', 'abc\r\ndef\r\n'),
                           'abc\ndef\n')
  
      def test_bug_1661(self):
          # Verify that flags do not get silently ignored with compiled patterns
          pattern = re.compile('.')
          self.assertRaises(ValueError, re.match, pattern, 'A', re.I)
          self.assertRaises(ValueError, re.search, pattern, 'A', re.I)
          self.assertRaises(ValueError, re.findall, pattern, 'A', re.I)
          self.assertRaises(ValueError, re.compile, pattern, re.I)
  
      def test_bug_3629(self):
          # A regex that triggered a bug in the sre-code validator
          re.compile("(?P<quote>)(?(quote))")
  
      def test_sub_template_numeric_escape(self):
          # bug 776311 and friends
          self.assertEqual(re.sub('x', r'\0', 'x'), '\0')
          self.assertEqual(re.sub('x', r'\000', 'x'), '\000')
          self.assertEqual(re.sub('x', r'\001', 'x'), '\001')
          self.assertEqual(re.sub('x', r'\008', 'x'), '\0' + '8')
          self.assertEqual(re.sub('x', r'\009', 'x'), '\0' + '9')
          self.assertEqual(re.sub('x', r'\111', 'x'), '\111')
          self.assertEqual(re.sub('x', r'\117', 'x'), '\117')
          self.assertEqual(re.sub('x', r'\377', 'x'), '\377')
  
          self.assertEqual(re.sub('x', r'\1111', 'x'), '\1111')
          self.assertEqual(re.sub('x', r'\1111', 'x'), '\111' + '1')
  
          self.assertEqual(re.sub('x', r'\00', 'x'), '\x00')
          self.assertEqual(re.sub('x', r'\07', 'x'), '\x07')
          self.assertEqual(re.sub('x', r'\08', 'x'), '\0' + '8')
          self.assertEqual(re.sub('x', r'\09', 'x'), '\0' + '9')
          self.assertEqual(re.sub('x', r'\0a', 'x'), '\0' + 'a')
  
          self.checkTemplateError('x', r'\400', 'x',
                                  r'octal escape value \400 outside of '
                                  r'range 0-0o377', 0)
          self.checkTemplateError('x', r'\777', 'x',
                                  r'octal escape value \777 outside of '
                                  r'range 0-0o377', 0)
  
          self.checkTemplateError('x', r'\1', 'x', 'invalid group reference 1', 1)
          self.checkTemplateError('x', r'\8', 'x', 'invalid group reference 8', 1)
          self.checkTemplateError('x', r'\9', 'x', 'invalid group reference 9', 1)
          self.checkTemplateError('x', r'\11', 'x', 'invalid group reference 11', 1)
          self.checkTemplateError('x', r'\18', 'x', 'invalid group reference 18', 1)
          self.checkTemplateError('x', r'\1a', 'x', 'invalid group reference 1', 1)
          self.checkTemplateError('x', r'\90', 'x', 'invalid group reference 90', 1)
          self.checkTemplateError('x', r'\99', 'x', 'invalid group reference 99', 1)
          self.checkTemplateError('x', r'\118', 'x', 'invalid group reference 11', 1)
          self.checkTemplateError('x', r'\11a', 'x', 'invalid group reference 11', 1)
          self.checkTemplateError('x', r'\181', 'x', 'invalid group reference 18', 1)
          self.checkTemplateError('x', r'\800', 'x', 'invalid group reference 80', 1)
          self.checkTemplateError('x', r'\8', '', 'invalid group reference 8', 1)
  
          # in python2.3 (etc), these loop endlessly in sre_parser.py
          self.assertEqual(re.sub('(((((((((((x)))))))))))', r'\11', 'x'), 'x')
          self.assertEqual(re.sub('((((((((((y))))))))))(.)', r'\118', 'xyz'),
                           'xz8')
          self.assertEqual(re.sub('((((((((((y))))))))))(.)', r'\11a', 'xyz'),
                           'xza')
  
      def test_qualified_re_sub(self):
          self.assertEqual(re.sub('a', 'b', 'aaaaa'), 'bbbbb')
          self.assertEqual(re.sub('a', 'b', 'aaaaa', 1), 'baaaa')
          self.assertEqual(re.sub('a', 'b', 'aaaaa', count=1), 'baaaa')
  
      def test_bug_114660(self):
          self.assertEqual(re.sub(r'(\S)\s+(\S)', r'\1 \2', 'hello  there'),
                           'hello there')
  
      def test_symbolic_groups(self):
          re.compile(r'(?P<a>x)(?P=a)(?(a)y)')
          re.compile(r'(?P<a1>x)(?P=a1)(?(a1)y)')
          re.compile(r'(?P<a1>x)\1(?(1)y)')
          self.checkPatternError(r'(?P<a>)(?P<a>)',
                                 "redefinition of group name 'a' as group 2; "
                                 "was group 1")
          self.checkPatternError(r'(?P<a>(?P=a))',
                                 "cannot refer to an open group", 10)
          self.checkPatternError(r'(?Pxy)', 'unknown extension ?Px')
          self.checkPatternError(r'(?P<a>)(?P=a', 'missing ), unterminated name', 11)
          self.checkPatternError(r'(?P=', 'missing group name', 4)
          self.checkPatternError(r'(?P=)', 'missing group name', 4)
          self.checkPatternError(r'(?P=1)', "bad character in group name '1'", 4)
          self.checkPatternError(r'(?P=a)', "unknown group name 'a'")
          self.checkPatternError(r'(?P=a1)', "unknown group name 'a1'")
          self.checkPatternError(r'(?P=a.)', "bad character in group name 'a.'", 4)
          self.checkPatternError(r'(?P<)', 'missing >, unterminated name', 4)
          self.checkPatternError(r'(?P<a', 'missing >, unterminated name', 4)
          self.checkPatternError(r'(?P<', 'missing group name', 4)
          self.checkPatternError(r'(?P<>)', 'missing group name', 4)
          self.checkPatternError(r'(?P<1>)', "bad character in group name '1'", 4)
          self.checkPatternError(r'(?P<a.>)', "bad character in group name 'a.'", 4)
          self.checkPatternError(r'(?(', 'missing group name', 3)
          self.checkPatternError(r'(?())', 'missing group name', 3)
          self.checkPatternError(r'(?(a))', "unknown group name 'a'", 3)
          self.checkPatternError(r'(?(-1))', "bad character in group name '-1'", 3)
          self.checkPatternError(r'(?(1a))', "bad character in group name '1a'", 3)
          self.checkPatternError(r'(?(a.))', "bad character in group name 'a.'", 3)
          # New valid/invalid identifiers in Python 3
          re.compile('(?P<µ>x)(?P=µ)(?(µ)y)')
